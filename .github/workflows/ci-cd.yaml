name: GitHub Actions Build and Deploy Demo
on:
  push:
    branches:
      - master
      - feature/**
  workflow_dispatch:

env:
  IMAGE_TAG: ${{ ((github.ref == 'refs/heads/master') || (startsWith(github.ref, 'refs/heads/bugfix'))) && 'production' || 'feature' }}

jobs:
  docker-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        
      - name: Echo variable
        run: |
          echo $GITHUB_REF_NAME
          echo $GITHUB_REF
          echo runner.os
          echo github.ref.name
      - name: Commit id variable
        id: vars
        shell: bash
        run: |
          echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"
      
      # - name: Trigger Webhook
      #   run: |
      #     curl -X POST -H 'Content-Type: application/json' -d '{commitId:${{ steps.vars.outputs.sha_short }}}' ${{secrets.WEBHOOK_LINK}}


          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      # So now you can use Actions' own caching!
      - name: Cache Docker layers
        uses: actions/cache@v2
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-
        
      - name: Docker Login
        uses: docker/login-action@v2.0.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push Production Image
        uses: docker/build-push-action@v2
        if: ${{ env.IMAGE_TAG == 'production' }}
        with:
          context: ./app
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/github-actions:${{ env.IMAGE_TAG}}-${{ steps.vars.outputs.sha_short }},${{ secrets.DOCKER_USERNAME }}/github-actions:${{ env.IMAGE_TAG}}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new

      - name: Build and push Feature Image
        uses: docker/build-push-action@v2
        if: ${{ env.IMAGE_TAG != 'production' }}
        with:
          context: ./app
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/github-actions:${{ env.IMAGE_TAG}}-${{ steps.vars.outputs.sha_short }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache